<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Openlayers地图展示</title>
    <!-- 引入本地OpenLayers的CSS文件 -->
    <link rel="stylesheet" href="C:\VSCode\openlayers-v6.15.1\css\ol.css" type="text/css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        nav {
            background-color: #333;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

            nav ul {
                list-style-type: none;
                margin: 0;
                padding: 0;
                display: flex;
            }

                nav ul li {
                    margin: 0 15px;
                }

                    nav ul li a {
                        color: white;
                        text-decoration: none;
                        transition: color 0.3s ease;
                    }

                        nav ul li a:hover {
                            color: #007BFF;
                        }

        .main-container {
            display: flex;
            flex: 1;
        }

        #map {
            flex: 1;
            height: calc(100vh - 120px);
        }

        .sidebar {
            width: 220px;
            background-color: #f4f4f4;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

            .sidebar button {
                background-color: #007BFF;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 8px 12px;
                cursor: pointer;
                margin-bottom: 10px;
                transition: background-color 0.3s ease;
            }

                .sidebar button:hover {
                    background-color: #0056b3;
                }

        #measurement-result {
            position: absolute;
            top: 60px;
            right: 10px;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .layer-switcher {
            position: absolute;
            top: 10px;
            left: 230px;
            background-color: white;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #mouse-position {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: white;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px;
        }
    </style>
    <!-- 引入本地OpenLayers的JavaScript文件 -->
    <script src="openlayers-v6.15.1/build/ol.js"></script>
    <!-- 引入天地图API -->
    <script type="text/javascript" src="http://api.tianditu.gov.cn/api?v=4.0&tk=6f34e1488df81340af0b23bfd0eb7b6b"></script>
</head>

<body>
    <nav>
        <ul>
            <li><a href="index.html">主网页</a></li>
            <li><a href="实习1.html">个人介绍</a></li>
            <li><a href="实习2.html">Canvas 绘图</a></li>
            <li><a href="实习3.html">WebGIS页面</a></li>
            <li><a href="实习4.html">Openlayers地图</a></li>
        </ul>
    </nav>

    <div class="main-container">
        <div class="sidebar">
            <button id="drawButton">绘制</button>
            <button id="measureButton">测量距离</button>
            <button id="measureAreaButton">测量面积</button>
            <button id="zoomInButton">放大</button>
            <button id="zoomOutButton">缩小</button>
            <button id="resetViewButton">重置视角</button>
            <button id="clearDrawButton">清空绘制</button>
        </div>

        <div id="map"></div>
    </div>

    <div id="measurement-result"></div>
    <div id="mouse-position"></div>

    <script>
        // 天地图底图配置
        const tdtLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'http://t0.tianditu.gov.cn/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=6f34e1488df81340af0b23bfd0eb7b6b'
            }),
            title: '天地图'
        });

        // 创建地图
        const map = new ol.Map({
            target: 'map',
            layers: [tdtLayer],
            view: new ol.View({
                center: ol.proj.fromLonLat([114.298572, 30.584355]),
                zoom: 12
            })
        });

        // 图层控制控件
        const layerSwitcher = new ol.control.LayerSwitcher();
        map.addControl(layerSwitcher);

        // 鼠标位置控件
        const mousePositionControl = new ol.control.MousePosition({
            coordinateFormat: ol.coordinate.createStringXY(4),
            projection: 'EPSG:4326',
            className: 'custom-mouse-position',
            target: document.getElementById('mouse-position'),
            undefinedHTML: '&nbsp;'
        });
        map.addControl(mousePositionControl);

        // 绘制功能
        let draw;
        const drawSource = new ol.source.Vector({ wrapX: false });
        const drawLayer = new ol.layer.Vector({
            source: drawSource,
            style: new ol.style.Style({
                fill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.2)' }),
                stroke: new ol.style.Stroke({ color: '#ffcc33', width: 2 }),
                image: new ol.style.Circle({ radius: 7, fill: new ol.style.Fill({ color: '#ffcc33' }) })
            })
        });
        map.addLayer(drawLayer);

        function addInteraction(type) {
            if (draw) map.removeInteraction(draw);
            draw = new ol.interaction.Draw({
                source: drawSource,
                type: type
            });
            map.addInteraction(draw);
        }

        document.getElementById('drawButton').addEventListener('click', () => addInteraction('Polygon'));

        // 测量功能
        const measureSource = new ol.source.Vector({ wrapX: false });
        const measureLayer = new ol.layer.Vector({
            source: measureSource,
            style: new ol.style.Style({
                fill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.2)' }),
                stroke: new ol.style.Stroke({ color: '#ff0000', width: 2 }),
                image: new ol.style.Circle({ radius: 7, fill: new ol.style.Fill({ color: '#ff0000' }) })
            })
        });
        map.addLayer(measureLayer);

        let measureDraw;
        let measureTooltipElement;
        let measureTooltip;

        function formatLength(line) {
            const length = ol.sphere.getLength(line);
            return length > 1000 ? (Math.round(length / 1000 * 100) / 100) + ' km' : (Math.round(length * 100) / 100) + ' m';
        }

        function formatArea(polygon) {
            const area = ol.sphere.getArea(polygon);
            return area > 1e6 ? (Math.round(area / 1e6 * 100) / 100) + ' km²' : (Math.round(area * 100) / 100) + ' m²';
        }

        function addMeasureInteraction(type) {
            if (measureDraw) map.removeInteraction(measureDraw);
            measureDraw = new ol.interaction.Draw({
                source: measureSource,
                type: type,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.2)' }),
                    stroke: new ol.style.Stroke({ color: 'rgba(0, 0, 0, 0.5)', lineDash: [10, 10], width: 2 }),
                    image: new ol.style.Circle({ radius: 5, stroke: new ol.style.Stroke({ color: 'rgba(0, 0, 0, 0.7)' }), fill: new ol.style.Fill({ color: 'rgba(255, 255, 255, 0.2)' }) })
                })
            });
            map.addInteraction(measureDraw);

            measureTooltipElement = document.createElement('div');
            measureTooltipElement.className = 'ol-tooltip ol-tooltip-measure';
            measureTooltip = new ol.Overlay({
                element: measureTooltipElement,
                offset: [0, -15],
                positioning: 'bottom-center'
            });
            map.addOverlay(measureTooltip);

            let listener;
            measureDraw.on('drawstart', (evt) => {
                const sketch = evt.feature;
                let tooltipCoord = evt.coordinate;

                listener = sketch.getGeometry().on('change', (evt) => {
                    const geom = evt.target;
                    let output;
                    if (geom instanceof ol.geom.Polygon) {
                        output = formatArea(geom);
                        tooltipCoord = geom.getInteriorPoint().getCoordinates();
                    } else if (geom instanceof ol.geom.LineString) {
                        output = formatLength(geom);
                        tooltipCoord = geom.getLastCoordinate();
                    }
                    measureTooltipElement.innerHTML = output;
                    measureTooltip.setPosition(tooltipCoord);
                });
            });

            measureDraw.on('drawend', () => {
                measureTooltipElement.className = 'ol-tooltip ol-tooltip-static';
                measureTooltip.setOffset([0, -7]);
                ol.Observable.unByKey(listener);
                measureDraw = null;
            });
        }

        document.getElementById('measureButton').addEventListener('click', () => addMeasureInteraction('LineString'));
        document.getElementById('measureAreaButton').addEventListener('click', () => addMeasureInteraction('Polygon'));

        // 缩放控制
        document.getElementById('zoomInButton').addEventListener('click', () => map.getView().setZoom(map.getView().getZoom() + 1));
        document.getElementById('zoomOutButton').addEventListener('click', () => map.getView().setZoom(map.getView().getZoom() - 1));

        // 重置视角
        document.getElementById('resetViewButton').addEventListener('click', () => {
            map.getView().setCenter(ol.proj.fromLonLat([114.298572, 30.584355]));
            map.getView().setZoom(12);
        });

        // 清空绘制
        document.getElementById('clearDrawButton').addEventListener('click', () => {
            drawSource.clear();
            measureSource.clear();
        });
    </script>

    <footer>
        <p>&copy; 2025 石逸飞 | 版权所有</p>
    </footer>
</body>
</html>
